<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch D·∫°y C√° Nh√¢n (PT)</title>
    <link rel="stylesheet" th:href="@{/css/lichlop.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="user">
            <span class="user-icon">&#128100;</span>
            <div>
                <div class="user-title">HU·∫§N LUY·ªÜN VI√äN</div>
                <div style="font-size: 14px; color: #666; margin-top: 4px;" th:text="${trainer != null ? trainer.tenNV : 'Trang ch·ªß'}">Trang ch·ªß</div>
            </div>
        </div>
        <nav>
            <ul>
                <li><a href="#" th:href="@{/trainer/home/{accountId}/{username}(accountId=${accountId}, username=${username})}">Trang ch·ªß</a></li>
                <li><a href="#" th:href="@{/trainer/lichlop/{accountId}/{username}(accountId=${accountId}, username=${username})}">L·ªãch d·∫°y l·ªõp</a></li>
                <li class="active"><a href="#">L·ªãch d·∫°y c√° nh√¢n</a></li>
                <li><a href="#">L∆∞∆°ng</a></li>
                <li><a href="#">Ph·∫£n h·ªìi/ Khi·∫øu n·∫°i</a></li>
                <li><a href="#">T√†i kho·∫£n</a></li>
            </ul>
        </nav>
        <form th:action="@{/logout}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="logout-btn">ƒêƒÇNG XU·∫§T</button>
        </form>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <h1>L·ªäCH D·∫†Y C√Å NH√ÇN (PERSONAL TRAINING)</h1>
        
        <!-- Error Message -->
        <div th:if="${error}" class="error-message" style="color: red; margin-bottom: 20px; padding: 10px; background: #ffebee; border: 1px solid #e57373; border-radius: 4px;">
            <span th:text="${error}"></span>
        </div>
        
        <!-- Success Message -->
        <div th:if="${successMessage}" class="success-message" style="color: green; margin-bottom: 20px; padding: 10px; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px;">
            <span th:text="${successMessage}"></span>
        </div>
        
        <!-- PT Customers Panel -->
        <div style="background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0; padding: 20px;">
            <h2>üèãÔ∏è‚Äç‚ôÇÔ∏è Kh√°ch H√†ng ƒê√£ ƒêƒÉng K√Ω PT</h2>
            <div th:if="${dsPTCustomers != null and !dsPTCustomers.isEmpty()}">
                <div th:each="customer : ${dsPTCustomers}" class="customer-card" style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 th:text="${customer.hoaDon.khachHang.hoTen}" style="margin: 0 0 10px 0; color: #333;">T√™n kh√°ch h√†ng</h4>
                            <p style="margin: 5px 0;" th:text="'D·ªãch v·ª•: ' + ${customer.dichVu.tenDV}">D·ªãch v·ª•</p>
                            <p style="margin: 5px 0;" th:text="'Email: ' + ${customer.hoaDon.khachHang.email}">Email</p>
                            <p style="margin: 5px 0;" th:text="'SƒêT: ' + ${customer.hoaDon.khachHang.soDienThoai}">SƒêT</p>
                            <p style="margin: 5px 0;" th:text="'T·ª´: ' + ${#temporals.format(customer.ngayBD, 'dd/MM/yyyy')} + ' - ' + ${#temporals.format(customer.ngayKT, 'dd/MM/yyyy')}">Th·ªùi h·∫°n</p>
                        </div>
                        <div style="margin-left: 20px;">
                            <button class="btn-add-schedule" 
                                    th:data-customer-id="${customer.hoaDon.khachHang.maKH}"
                                    th:data-customer-name="${customer.hoaDon.khachHang.hoTen}"
                                    th:data-start-date="${#temporals.format(customer.ngayBD, 'yyyy-MM-dd')}"
                                    th:data-end-date="${#temporals.format(customer.ngayKT, 'yyyy-MM-dd')}"
                                    onclick="openAddScheduleModal(this)"
                                    style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                üìÖ Th√™m L·ªãch T·∫≠p
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div th:if="${dsPTCustomers == null or dsPTCustomers.isEmpty()}">
                <p style="text-align: center; color: #666; padding: 20px;">
                    Ch∆∞a c√≥ kh√°ch h√†ng n√†o ƒëƒÉng k√Ω PT v·ªõi b·∫°n.
                </p>
            </div>
        </div>
        
        <!-- PT Schedules Panel -->
        <div style="background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0; padding: 20px;">
            <h2>üìÖ L·ªãch PT Hi·ªán T·∫°i</h2>
            <div th:if="${dsPTSchedules != null and !dsPTSchedules.isEmpty()}">
                <div th:each="schedule : ${dsPTSchedules}" class="schedule-card" style="background: #fff3cd; border: 2px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <p style="margin: 5px 0;"><strong>M√£ l·ªãch:</strong> <span th:text="${schedule.maLT}">LT001</span></p>
                            <p style="margin: 5px 0;"><strong>Kh√°ch h√†ng:</strong> <span th:text="${schedule.khachHang != null ? schedule.khachHang.hoTen : 'N/A'}">N/A</span></p>
                            <p style="margin: 5px 0;"><strong>Ca t·∫≠p:</strong> <span th:text="${schedule.caTap != null ? schedule.caTap.tenCa + ' (' + schedule.caTap.moTa + ')' : 'N/A'}">N/A</span></p>
                            <p style="margin: 5px 0;"><strong>Th·ª©:</strong> <span th:text="${schedule.thu != null ? schedule.thu : 'N/A'}">N/A</span></p>
                            <p style="margin: 5px 0;"><strong>Khu v·ª±c:</strong> <span th:text="${schedule.khuVuc != null ? schedule.khuVuc.tenKhuVuc : 'Ch∆∞a x√°c ƒë·ªãnh'}">N/A</span></p>
                            <p style="margin: 5px 0;"><strong>Tr·∫°ng th√°i:</strong> 
                                <span th:class="${schedule.trangThai == 'Dang mo' ? 'status-active' : 'status-inactive'}" 
                                      th:text="${schedule.trangThai != null ? schedule.trangThai : 'N/A'}" 
                                      style="padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">N/A</span>
                            </p>
                        </div>
                        <div style="margin-left: 20px;">
                            <button onclick="editSchedule(this)" 
                                    th:data-schedule-id="${schedule.maLT}"
                                    style="background: #ffc107; color: #212529; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                ‚úèÔ∏è S·ª≠a
                            </button>
                            <button onclick="deleteSchedule(this)" 
                                    th:data-schedule-id="${schedule.maLT}"
                                    style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                üóëÔ∏è X√≥a
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div th:if="${dsPTSchedules == null or dsPTSchedules.isEmpty()}">
                <p style="text-align: center; color: #666; padding: 20px;">
                    Ch∆∞a c√≥ l·ªãch d·∫°y PT n√†o ƒë∆∞·ª£c t·∫°o.
                </p>
            </div>
        </div>

        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px; color: #333;">üß™ Test T·∫°o L·ªãch PT</h3>
            <button onclick="debugSession()" style="background: #6f42c1; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                Debug Session
            </button>
            <button onclick="debugPTCustomers()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                Debug Kh√°ch H√†ng PT
            </button>
            <button onclick="testCreatePTSchedule()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                Test T·∫°o L·ªãch PT
            </button>
            <div id="testResult" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
        </div>
    </div>
</div>

<!-- Add Schedule Modal -->
<div id="addScheduleModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: none; border-radius: 10px; width: 80%; max-width: 500px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">üìÖ Th√™m L·ªãch T·∫≠p PT</h2>
            <span class="close" onclick="closeAddScheduleModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        </div>
        
        <form id="addScheduleForm">
            <input type="hidden" id="customerIdInput" name="maKH">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Kh√°ch h√†ng:</label>
                <input type="text" id="customerNameInput" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Th·ªùi h·∫°n PT:</label>
                <input type="text" id="ptPeriodInput" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ch·ªçn ng√†y t·∫≠p:</label>
                <input type="date" id="ngayTapInput" name="ngayTap" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #666; font-size: 12px;">Ch·ªçn ng√†y trong kho·∫£ng th·ªùi gian PT c·ªßa kh√°ch h√†ng</small>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ca t·∫≠p:</label>
                <select name="caTap" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Ch·ªçn ca t·∫≠p</option>
                    <option th:each="ca : ${dsCaTap}" th:value="${ca.maCa}" th:text="${ca.tenCa + ' (' + ca.moTa + ')'}">Ca 1</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Khu v·ª±c:</label>
                <select name="maKV" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Ch·ªçn khu v·ª±c (t√πy ch·ªçn)</option>
                    <option th:each="kv : ${dsKhuVuc}" th:value="${kv.maKV}" th:text="${kv.tenKhuVuc}">Khu v·ª±c</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeAddScheduleModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                    H·ªßy
                </button>
                <button type="submit" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                    T·∫°o L·ªãch
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.status-active {
    background-color: #d4edda;
    color: #155724;
}

.status-inactive {
    background-color: #f8d7da;
    color: #721c24;
}

.customer-card:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transform: translateY(-2px);
    transition: all 0.3s ease;
}

.schedule-card:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transform: translateY(-2px);
    transition: all 0.3s ease;
}
</style>

<script>
    console.log('üéØ Trang l·ªãch d·∫°y c√° nh√¢n ƒë√£ load th√†nh c√¥ng!');
    
    function openAddScheduleModal(button) {
        const customerId = button.getAttribute('data-customer-id');
        const customerName = button.getAttribute('data-customer-name');
        const startDate = button.getAttribute('data-start-date');
        const endDate = button.getAttribute('data-end-date');
        
        document.getElementById('customerIdInput').value = customerId;
        document.getElementById('customerNameInput').value = customerName;
        
        // Hi·ªÉn th·ªã th·ªùi h·∫°n PT
        const startDateFormatted = formatDateToVietnamese(startDate);
        const endDateFormatted = formatDateToVietnamese(endDate);
        document.getElementById('ptPeriodInput').value = `${startDateFormatted} - ${endDateFormatted}`;
        
        // Set min v√† max cho date input
        document.getElementById('ngayTapInput').min = startDate;
        document.getElementById('ngayTapInput').max = endDate;
        
        document.getElementById('addScheduleModal').style.display = 'block';
    }
    
    function formatDateToVietnamese(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN');
    }
    
    function closeAddScheduleModal() {
        document.getElementById('addScheduleModal').style.display = 'none';
        document.getElementById('addScheduleForm').reset();
    }
    
    // Handle form submission
    document.getElementById('addScheduleForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        formData.append('accountId', '[[${accountId}]]');
        
        // Validate ng√†y t·∫≠p
        const ngayTap = document.getElementById('ngayTapInput').value;
        const minDate = document.getElementById('ngayTapInput').min;
        const maxDate = document.getElementById('ngayTapInput').max;
        
        if (ngayTap < minDate || ngayTap > maxDate) {
            alert('Ng√†y t·∫≠p ph·∫£i n·∫±m trong kho·∫£ng th·ªùi gian PT c·ªßa kh√°ch h√†ng!');
            return;
        }
        
        try {
            // Prepare data for new endpoint
            const requestData = new URLSearchParams();
            requestData.append('maNV', '[[${maNV}]]');
            requestData.append('maKH', formData.get('maKH'));
            requestData.append('ngayTap', formData.get('ngayTap'));
            requestData.append('caTap', formData.get('caTap'));
            requestData.append('maKV', formData.get('maKV') || '');
            
            // Add CSRF token
            const csrfToken = document.querySelector('input[name="_csrf"]').value;
            requestData.append('_csrf', csrfToken);
            
            const response = await fetch('/trainer/createPTScheduleWithDate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: requestData
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('T·∫°o l·ªãch PT th√†nh c√¥ng! M√£ l·ªãch: ' + result.data);
                closeAddScheduleModal();
                location.reload(); // Reload to show new schedule
            } else {
                alert('L·ªói: ' + result.message);
            }
        } catch (error) {
            alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
        }
    });
    
    function editSchedule(button) {
        const scheduleId = button.getAttribute('data-schedule-id');
        alert('Ch·ª©c nƒÉng s·ª≠a l·ªãch s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn sau. M√£ l·ªãch: ' + scheduleId);
    }
    
    function deleteSchedule(button) {
        const scheduleId = button.getAttribute('data-schedule-id');
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªãch n√†y?')) {
            alert('Ch·ª©c nƒÉng x√≥a l·ªãch s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn sau. M√£ l·ªãch: ' + scheduleId);
        }
    }
    
    // Test function to create PT schedule
    async function testCreatePTSchedule() {
        const resultDiv = document.getElementById('testResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '‚è≥ ƒêang test t·∫°o l·ªãch PT...';
        resultDiv.style.backgroundColor = '#fff3cd';
        resultDiv.style.color = '#856404';
        
        try {
            const response = await fetch('/trainer/testCreatePTSchedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `maNV=[[${maNV}]]&maKH=KH003&ngayTap=2025-01-15&caTap=CA01&maKV=KV01`
            });
            
            const result = await response.json();
            
            if (result.success) {
                resultDiv.innerHTML = '‚úÖ ' + result.message + ' (M√£ l·ªãch: ' + result.data + ')';
                resultDiv.style.backgroundColor = '#d4edda';
                resultDiv.style.color = '#155724';
                
                // Reload page after 2 seconds
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                resultDiv.innerHTML = '‚ùå ' + result.message;
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.color = '#721c24';
            }
        } catch (error) {
            resultDiv.innerHTML = '‚ùå L·ªói: ' + error.message;
            resultDiv.style.backgroundColor = '#f8d7da';
            resultDiv.style.color = '#721c24';
        }
    }
    
    // Debug function to check PT customers
    async function debugPTCustomers() {
        const resultDiv = document.getElementById('testResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '‚è≥ ƒêang ki·ªÉm tra kh√°ch h√†ng PT...';
        resultDiv.style.backgroundColor = '#fff3cd';
        resultDiv.style.color = '#856404';
        
        try {
            const response = await fetch(`/trainer/debug/ptCustomers/[[${maNV}]]`);
            const result = await response.json();
            
            if (result.success) {
                let html = 'üìã Danh s√°ch kh√°ch h√†ng PT:<br>';
                if (result.data && result.data.length > 0) {
                    result.data.forEach(customer => {
                        html += `‚Ä¢ ${customer.tenKH} (${customer.maKH}) - ${customer.tenDV}<br>`;
                        html += `  Th·ªùi h·∫°n: ${customer.ngayBD} - ${customer.ngayKT}<br>`;
                    });
                } else {
                    html += 'Kh√¥ng c√≥ kh√°ch h√†ng PT n√†o.';
                }
                
                resultDiv.innerHTML = html;
                resultDiv.style.backgroundColor = '#d1ecf1';
                resultDiv.style.color = '#0c5460';
            } else {
                resultDiv.innerHTML = '‚ùå ' + result.message;
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.color = '#721c24';
            }
        } catch (error) {
            resultDiv.innerHTML = '‚ùå L·ªói: ' + error.message;
            resultDiv.style.backgroundColor = '#f8d7da';
            resultDiv.style.color = '#721c24';
        }
    }
    
    // Debug function to check session
    async function debugSession() {
        const resultDiv = document.getElementById('testResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '‚è≥ ƒêang ki·ªÉm tra session...';
        resultDiv.style.backgroundColor = '#fff3cd';
        resultDiv.style.color = '#856404';
        
        try {
            const response = await fetch('/trainer/debug/session');
            const result = await response.json();
            
            if (result.success) {
                let html = 'üîç Th√¥ng tin Session:<br>';
                html += `Session ID: ${result.sessionId}<br>`;
                html += `Is New: ${result.isNew}<br>`;
                html += 'Attributes:<br>';
                
                if (result.attributes && Object.keys(result.attributes).length > 0) {
                    Object.entries(result.attributes).forEach(([key, value]) => {
                        html += `  ‚Ä¢ ${key}: ${value}<br>`;
                    });
                } else {
                    html += '  Kh√¥ng c√≥ attributes n√†o.';
                }
                
                resultDiv.innerHTML = html;
                resultDiv.style.backgroundColor = '#e2e3e5';
                resultDiv.style.color = '#383d41';
            } else {
                resultDiv.innerHTML = '‚ùå ' + result.message;
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.color = '#721c24';
            }
        } catch (error) {
            resultDiv.innerHTML = '‚ùå L·ªói: ' + error.message;
            resultDiv.style.backgroundColor = '#f8d7da';
            resultDiv.style.color = '#721c24';
        }
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('addScheduleModal');
        if (event.target === modal) {
            closeAddScheduleModal();
        }
    }
</script>
</body>
</html> 